name: Reusable Test Workflow

on:
  workflow_call:
    inputs:
      go-version:
        description: 'Go version to use'
        required: false
        type: string
        default: '1.24'
      node-version:
        description: 'Node.js version to use'
        required: false
        type: string
        default: '20'
      run-backend-tests:
        description: 'Run backend tests'
        required: false
        type: boolean
        default: true
      run-frontend-tests:
        description: 'Run frontend tests'
        required: false
        type: boolean
        default: true
      run-integration-tests:
        description: 'Run integration tests'
        required: false
        type: boolean
        default: false
      coverage-threshold:
        description: 'Minimum coverage percentage'
        required: false
        type: number
        default: 70
    outputs:
      backend-coverage:
        description: 'Backend test coverage percentage'
        value: ${{ jobs.backend-test.outputs.coverage }}
      frontend-coverage:
        description: 'Frontend test coverage percentage'
        value: ${{ jobs.frontend-test.outputs.coverage }}

jobs:
  backend-test:
    name: Backend Tests
    runs-on: ubuntu-latest
    if: ${{ inputs.run-backend-tests }}

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: gorax
          POSTGRES_PASSWORD: gorax_test
          POSTGRES_DB: gorax_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:6
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    outputs:
      coverage: ${{ steps.coverage.outputs.percentage }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.go-version }}
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run tests with coverage
        env:
          DATABASE_URL: postgres://gorax:gorax_test@localhost:5432/gorax_test?sslmode=disable
          REDIS_URL: redis://localhost:6379
          ENV: test
        run: |
          go test -v -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: Extract coverage
        id: coverage
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "Backend coverage: ${COVERAGE}%"

      - name: Check coverage threshold
        run: |
          COVERAGE=${{ steps.coverage.outputs.percentage }}
          THRESHOLD=${{ inputs.coverage-threshold }}
          if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            echo "❌ Coverage ${COVERAGE}% is below threshold ${THRESHOLD}%"
            exit 1
          fi
          echo "✅ Coverage ${COVERAGE}% meets threshold ${THRESHOLD}%"

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: coverage.out
          retention-days: 7

  frontend-test:
    name: Frontend Tests
    runs-on: ubuntu-latest
    if: ${{ inputs.run-frontend-tests }}
    defaults:
      run:
        working-directory: ./web

    outputs:
      coverage: ${{ steps.coverage.outputs.percentage }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Extract coverage
        id: coverage
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            COVERAGE=$(cat coverage/coverage-summary.json | grep -o '"lines":{[^}]*}' | grep -o '"pct":[0-9.]*' | cut -d: -f2)
            echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT
            echo "Frontend coverage: ${COVERAGE}%"
          else
            echo "percentage=0" >> $GITHUB_OUTPUT
          fi

      - name: Check coverage threshold
        run: |
          COVERAGE=${{ steps.coverage.outputs.percentage }}
          THRESHOLD=${{ inputs.coverage-threshold }}
          if [ "$COVERAGE" != "0" ] && (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            echo "❌ Coverage ${COVERAGE}% is below threshold ${THRESHOLD}%"
            exit 1
          fi
          echo "✅ Coverage ${COVERAGE}% meets threshold ${THRESHOLD}%"

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: web/coverage/
          retention-days: 7

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    if: ${{ inputs.run-integration-tests }}
    needs: [backend-test, frontend-test]

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: gorax
          POSTGRES_PASSWORD: gorax_test
          POSTGRES_DB: gorax_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:6
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.go-version }}
          cache: true

      - name: Run integration tests
        env:
          DATABASE_URL: postgres://gorax:gorax_test@localhost:5432/gorax_test?sslmode=disable
          REDIS_URL: redis://localhost:6379
          ENV: test
        run: |
          go test -v -tags=integration ./...

      - name: Upload integration test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: |
            *.log
            test-results/
          retention-days: 7
