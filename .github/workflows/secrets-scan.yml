name: Secrets Scanning

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - main
      - dev
  schedule:
    # Run daily at 2:00 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  gitleaks:
    name: Gitleaks Secret Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

      - name: Upload Gitleaks report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: results.sarif
          retention-days: 30

  trufflehog:
    name: TruffleHog Secret Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

  secret-patterns:
    name: Custom Secret Pattern Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for common secret patterns
        run: |
          echo "Scanning for potential secrets..."

          # Check for common secret patterns
          FOUND_ISSUES=0

          # AWS keys
          if grep -r "AKIA[0-9A-Z]{16}" . --exclude-dir={.git,node_modules,vendor,dist,bin} 2>/dev/null; then
            echo "‚ö†Ô∏è Found potential AWS access key"
            FOUND_ISSUES=1
          fi

          # Private keys (exclude template/example files, Makefile security check patterns)
          if grep -r "BEGIN.*PRIVATE KEY" . --exclude-dir={.git,node_modules,vendor,dist,bin,docs,terraform} --exclude="*.template.*" --exclude="*.example.*" --exclude="*_test.go" --exclude="*.skip" --exclude="TASKS.md" --exclude="Makefile" 2>/dev/null | grep -v "secrets.template.yml" | grep -v "SSO_OKTA_SAML.md" | grep -v "README.md"; then
            echo "‚ö†Ô∏è Found potential private key"
            FOUND_ISSUES=1
          fi

          # Generic API tokens
          if grep -r "api[_-]?key.*=.*['\"][a-zA-Z0-9]{32,}['\"]" . --exclude-dir={.git,node_modules,vendor,dist,bin} 2>/dev/null; then
            echo "‚ö†Ô∏è Found potential API key"
            FOUND_ISSUES=1
          fi

          # Database URLs with credentials (exclude docs, tests, scripts, examples, Makefile)
          if grep -r "postgres://.*:.*@" . --exclude-dir={.git,node_modules,vendor,dist,bin,.github,docs,tests,scripts,deployments} --exclude="*.md" --exclude="*_test.go" --exclude="*.sh" --exclude="*.skip" --exclude="docker-compose*.yml" --exclude="Makefile" 2>/dev/null; then
            echo "‚ö†Ô∏è Found potential database URL with credentials"
            FOUND_ISSUES=1
          fi

          if [ $FOUND_ISSUES -eq 1 ]; then
            echo ""
            echo "‚ùå Potential secrets found! Please review the above output."
            echo "If these are false positives, add them to .gitignore or use environment variables."
            exit 1
          else
            echo "‚úÖ No obvious secret patterns detected"
          fi

      - name: Check for hardcoded credentials in config files
        run: |
          echo "Checking configuration files for hardcoded credentials..."

          # Check .env files (should not be committed)
          if find . -name ".env" -not -path "*/node_modules/*" -not -path "*/.git/*" | grep -q .; then
            echo "‚ö†Ô∏è Found .env files in repository:"
            find . -name ".env" -not -path "*/node_modules/*" -not -path "*/.git/*"
            echo "üí° Use .env.example instead and add .env to .gitignore"
            exit 1
          fi

          # Check for credentials in JSON/YAML
          if grep -r "password.*:.*['\"][^{][^}].*['\"]" . \
            --include="*.json" \
            --include="*.yaml" \
            --include="*.yml" \
            --exclude-dir={.git,node_modules,vendor,dist,bin} 2>/dev/null; then
            echo "‚ö†Ô∏è Found potential hardcoded passwords in config files"
            exit 1
          fi

          echo "‚úÖ No hardcoded credentials found in config files"

  notification:
    name: Notify on Secrets Found
    runs-on: ubuntu-latest
    needs: [gitleaks, trufflehog, secret-patterns]
    if: failure() && github.event_name != 'pull_request'

    steps:
      - name: Send notification
        run: |
          echo "üö® Secrets scanning detected potential issues!"
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo ""
          echo "Please review the workflow logs and take immediate action if real secrets were exposed."
          echo ""
          echo "Recommended actions:"
          echo "1. Revoke any exposed credentials immediately"
          echo "2. Update secrets in your secret management system"
          echo "3. Review git history and consider using tools like git-filter-repo"
          echo "4. Add patterns to .gitignore to prevent future occurrences"

          # Add your notification integrations here:
          # - Slack webhook
          # - PagerDuty alert
          # - Email notification
