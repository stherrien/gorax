{
  "environment": {
    "name": "production",
    "url": "https://gorax.dev",
    "description": "Production environment with strict deployment controls"
  },
  "protection_rules": {
    "wait_timer": 5,
    "wait_timer_description": "5 minute wait period allows time to cancel deployment if needed",
    "reviewers": {
      "required_count": 1,
      "users": [
        {
          "note": "Add GitHub user IDs here",
          "example": "12345678",
          "how_to_get": "gh api users/{username} | jq .id"
        }
      ],
      "teams": [
        {
          "note": "Or add team IDs for organization",
          "example": "87654321",
          "how_to_get": "gh api orgs/{org}/teams/{team} | jq .id"
        }
      ]
    },
    "deployment_branch_policy": {
      "protected_branches": false,
      "custom_branch_policies": true,
      "allowed_branches": [
        {
          "name": "main",
          "type": "branch"
        }
      ]
    },
    "prevent_self_review": true,
    "notify_reviewers": true
  },
  "secrets": {
    "PRODUCTION_URL": {
      "description": "Production environment URL",
      "required": true,
      "example": "https://gorax.dev"
    },
    "PRODUCTION_DB_PASSWORD": {
      "description": "Production database password",
      "required": true,
      "generate_with": "openssl rand -base64 48",
      "security_notes": [
        "Minimum 32 characters",
        "Store backup in secure vault",
        "Rotate every 90 days",
        "Never log or print"
      ]
    },
    "PRODUCTION_REDIS_PASSWORD": {
      "description": "Production Redis password",
      "required": false,
      "generate_with": "openssl rand -base64 32",
      "security_notes": [
        "Rotate every 90 days"
      ]
    },
    "HEALTH_CHECK_TOKEN": {
      "description": "Bearer token for health check endpoints",
      "required": true,
      "generate_with": "openssl rand -hex 48",
      "security_notes": [
        "Used by external monitoring",
        "Read-only permissions",
        "Rotate every 180 days"
      ]
    },
    "CREDENTIAL_MASTER_KEY": {
      "description": "Master encryption key for credential encryption",
      "required": true,
      "generate_with": "openssl rand -base64 32",
      "security_notes": [
        "CRITICAL: Loss means all credentials unrecoverable",
        "Store in multiple secure locations",
        "Consider AWS KMS for production",
        "Rotate annually with re-encryption plan"
      ]
    }
  },
  "variables": {
    "ENVIRONMENT": "production",
    "LOG_LEVEL": "info",
    "METRICS_ENABLED": "true",
    "TRACING_ENABLED": "true",
    "SENTRY_ENABLED": "true"
  },
  "deployment_workflow": {
    "workflow_file": ".github/workflows/deploy-production.yml",
    "trigger": "push to main branch or manual workflow dispatch",
    "approval_required": true,
    "automatic": false,
    "steps": [
      "1. Build and test",
      "2. Build Docker image",
      "3. Wait for approval",
      "4. Deploy database migrations",
      "5. Deploy application",
      "6. Run health checks",
      "7. Run smoke tests"
    ]
  },
  "usage_notes": [
    "Requires manual approval from designated reviewers",
    "5 minute wait timer provides safety window",
    "Only deploys from main branch",
    "All status checks must pass",
    "Comprehensive health checks after deployment",
    "Automatic rollback on failure"
  ],
  "approval_process": {
    "steps": [
      "1. Deployment is triggered (push to main or manual)",
      "2. Pre-deployment checks run",
      "3. Docker image is built",
      "4. Reviewers are notified",
      "5. Reviewer approves via GitHub UI or API",
      "6. 5 minute wait timer starts",
      "7. Database migrations run",
      "8. Application deploys",
      "9. Health checks verify deployment"
    ],
    "approval_via_ui": [
      "1. Go to repository Actions tab",
      "2. Find pending deployment",
      "3. Click 'Review deployments'",
      "4. Select production environment",
      "5. Add comment (optional)",
      "6. Click 'Approve and deploy'"
    ],
    "approval_via_api": [
      "gh api repos/{owner}/{repo}/actions/runs/{run_id}/pending_deployments \\",
      "  -f environment_ids[]={env_id} \\",
      "  -f state=approved \\",
      "  -f comment='Approved for production deployment'"
    ]
  },
  "setup_instructions": {
    "via_ui": [
      "1. Navigate to Settings â†’ Environments",
      "2. Click 'New environment'",
      "3. Name: production",
      "4. Configure protection rules:",
      "   - Add required reviewers (at least 1)",
      "   - Set wait timer to 5 minutes",
      "   - Configure deployment branches: main only",
      "5. Add secrets from secrets.template.yml",
      "6. Add environment variables",
      "7. Test with workflow dispatch"
    ],
    "via_cli": [
      "# Create environment",
      "gh api repos/{owner}/{repo}/environments/production -X PUT \\",
      "  -f 'deployment_branch_policy[protected_branches]=false' \\",
      "  -f 'deployment_branch_policy[custom_branch_policies]=true' \\",
      "  -f 'wait_timer=5'",
      "",
      "# Add required reviewers",
      "# Note: Requires user/team IDs, not usernames",
      "USER_ID=$(gh api users/{username} | jq .id)",
      "gh api repos/{owner}/{repo}/environments/production -X PUT \\",
      "  -f \"reviewers[0][type]=User\" \\",
      "  -f \"reviewers[0][id]=$USER_ID\" \\",
      "  -f 'deployment_branch_policy[protected_branches]=false' \\",
      "  -f 'deployment_branch_policy[custom_branch_policies]=true' \\",
      "  -f 'wait_timer=5'",
      "",
      "# Add branch policy",
      "gh api repos/{owner}/{repo}/environments/production/deployment-branch-policies -X POST \\",
      "  -f 'name=main' -f 'type=branch'",
      "",
      "# Add secrets",
      "gh secret set PRODUCTION_URL --env production --body 'https://gorax.dev'",
      "gh secret set PRODUCTION_DB_PASSWORD --env production < /path/to/password",
      "gh secret set HEALTH_CHECK_TOKEN --env production < /path/to/token"
    ],
    "via_terraform": [
      "# See terraform/github/environments.tf",
      "cd terraform/github",
      "",
      "# Update terraform.tfvars with reviewer IDs",
      "# Get user ID: gh api users/{username} | jq .id",
      "production_reviewers = [12345678]",
      "",
      "terraform init",
      "terraform apply -target=github_repository_environment.production"
    ]
  },
  "verification": {
    "check_environment_exists": "gh api repos/{owner}/{repo}/environments/production",
    "check_protection_rules": "gh api repos/{owner}/{repo}/environments/production | jq '.protection_rules'",
    "check_reviewers": "gh api repos/{owner}/{repo}/environments/production | jq '.reviewers'",
    "check_wait_timer": "gh api repos/{owner}/{repo}/environments/production | jq '.wait_timer'",
    "list_secrets": "gh api repos/{owner}/{repo}/environments/production/secrets | jq -r '.secrets[].name'",
    "trigger_deployment": [
      "# Via push to main",
      "git push origin main",
      "",
      "# Via manual dispatch",
      "gh workflow run deploy-production.yml"
    ]
  },
  "emergency_procedures": {
    "hotfix_deployment": {
      "description": "Emergency deployment process for critical fixes",
      "steps": [
        "1. Create hotfix branch from main: git checkout -b hotfix/RFLOW-XXX-description main",
        "2. Commit fix with clear description",
        "3. Push and create PR to main",
        "4. Get expedited review",
        "5. Merge to main",
        "6. Monitor deployment closely",
        "7. Verify fix in production",
        "8. Backport to dev if needed"
      ],
      "approval": "Requires same approval as regular deployment"
    },
    "rollback": {
      "description": "Roll back to previous version",
      "kubernetes": [
        "kubectl rollout undo deployment/gorax-api",
        "kubectl rollout status deployment/gorax-api"
      ],
      "aws_ecs": [
        "aws ecs update-service --cluster production --service gorax-api --task-definition gorax-api:PREVIOUS_VERSION --force-new-deployment"
      ],
      "docker": [
        "docker service update --image gorax:previous-tag gorax"
      ]
    },
    "incident_response": {
      "severity_1": [
        "1. Page on-call engineer",
        "2. Create incident channel",
        "3. Assess impact",
        "4. Decide: rollback or hotfix",
        "5. Execute chosen action",
        "6. Verify resolution",
        "7. Post-incident review"
      ]
    }
  },
  "monitoring": {
    "deployment_notifications": [
      "Slack: #gorax-deployments",
      "Email: devops@gorax.dev",
      "PagerDuty: Production alerts"
    ],
    "health_checks": [
      "https://gorax.dev/health",
      "https://gorax.dev/health/db",
      "https://gorax.dev/health/redis"
    ],
    "dashboards": [
      "Grafana: https://grafana.gorax.dev/d/production",
      "Sentry: https://sentry.io/organizations/gorax/projects/gorax-production/"
    ]
  },
  "compliance": {
    "audit_logging": "All deployments are logged with approver, timestamp, and commit SHA",
    "change_management": "All production changes require PR, review, and approval",
    "access_control": "Only designated reviewers can approve production deployments",
    "backup_policy": "Database backup before each deployment",
    "documentation": "Runbook must be updated for major changes"
  },
  "best_practices": [
    "Always test in staging before production",
    "Deploy during low-traffic hours when possible",
    "Monitor metrics closely after deployment",
    "Have rollback plan ready",
    "Communicate deployment in team channels",
    "Update documentation and changelog",
    "Run smoke tests after deployment",
    "Keep deployment window short"
  ]
}
